blueprint:
  name: ZHA Remote - Univerzální Ovládání (Čisté akce s volitelným filtrem zapnutých světel)
  description: >
    Univerzální blueprint pro ZHA dálkový ovladač (např. Ikea STYRBAR E2001/E2002).
    Umožňuje nastavit akce pro single/double/triple klik na horní, spodní, levé a pravé tlačítko,
    a také akce při držení tlačítka (hold) pro zvýšení/snížení jasu (horní/dolní) a při držení
    levého/pravého tlačítka.  

    Navíc lze samostatně nastavit, zda se při držení horního/spodního tlačítka (pro jas),
    levého tlačítka a pravého tlačítka mají akce provést pouze na aktuálně zapnutých světlech.
  
  domain: automation
  input:
    remote:
      name: ZHA Dálkový ovladač
      description: Vyberte zařízení ZHA ovladače.
      selector:
        device:
          integration: zha

    wait_time:
      name: Čas pro rozlišení počtu stisků (s)
      description: Doba, po kterou se čeká na další stisk pro dvojité/trojité kliknutí.
      default: 0.5
      selector:
        number:
          min: 0.1
          max: 2
          step: 0.1
          unit_of_measurement: s

    only_active_lights_brightness:
      name: Pouze zapnutá světla pro hold horní/dolní (jas)
      description: Pokud zapnuto, hold akce pro zvýšení/snížení jasu (horní/dolní) se aplikují jen na zapnutá světla.
      default: false
      selector:
        boolean: {}

    only_active_lights_left:
      name: Pouze zapnutá světla pro hold levého tlačítka
      description: Pokud zapnuto, hold akce levého tlačítka se aplikují jen na zapnutá světla.
      default: false
      selector:
        boolean: {}

    only_active_lights_right:
      name: Pouze zapnutá světla pro hold pravého tlačítka
      description: Pokud zapnuto, hold akce pravého tlačítka se aplikují jen na zapnutá světla.
      default: false
      selector:
        boolean: {}

    # Akce pro horní tlačítko (klik)
    single_click_action_top:
      name: Horní tlačítko - jeden klik
      default: []
      selector:
        action: {}
    double_click_action_top:
      name: Horní tlačítko - dvojitý klik
      default: []
      selector:
        action: {}
    triple_click_action_top:
      name: Horní tlačítko - trojitý klik
      default: []
      selector:
        action: {}

    # Akce pro spodní tlačítko (klik)
    single_click_action_bottom:
      name: Spodní tlačítko - jeden klik
      default: []
      selector:
        action: {}
    double_click_action_bottom:
      name: Spodní tlačítko - dvojitý klik
      default: []
      selector:
        action: {}
    triple_click_action_bottom:
      name: Spodní tlačítko - trojitý klik
      default: []
      selector:
        action: {}

    # Akce pro levé tlačítko (klik)
    single_click_action_left:
      name: Levé tlačítko - jeden klik
      default: []
      selector:
        action: {}
    double_click_action_left:
      name: Levé tlačítko - dvojitý klik
      default: []
      selector:
        action: {}
    triple_click_action_left:
      name: Levé tlačítko - trojitý klik
      default: []
      selector:
        action: {}

    # Akce pro pravé tlačítko (klik)
    single_click_action_right:
      name: Pravé tlačítko - jeden klik
      default: []
      selector:
        action: {}
    double_click_action_right:
      name: Pravé tlačítko - dvojitý klik
      default: []
      selector:
        action: {}
    triple_click_action_right:
      name: Pravé tlačítko - trojitý klik
      default: []
      selector:
        action: {}

    # Akce pro držení horního tlačítka (zvýšení jasu)
    hold_increase_top:
      name: Držení horního tlačítka (zvýšení jasu)
      default: []
      selector:
        action: {}

    # Akce pro držení spodního tlačítka (snížení jasu)
    hold_decrease_bottom:
      name: Držení spodního tlačítka (snížení jasu)
      default: []
      selector:
        action: {}

    # Akce pro držení levého tlačítka
    hold_left:
      name: Držení levého tlačítka
      default: []
      selector:
        action: {}

    # Akce pro držení pravého tlačítka
    hold_right:
      name: Držení pravého tlačítka
      default: []
      selector:
        action: {}

trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: !input remote

variables:
  command: "{{ trigger.event.data.command }}"
  cluster_id: "{{ trigger.event.data.cluster_id }}"
  endpoint_id: "{{ trigger.event.data.endpoint_id }}"
  wt: !input wait_time
  only_bright: !input only_active_lights_brightness
  only_left: !input only_active_lights_left
  only_right: !input only_active_lights_right

  button_name: >
    {% if cluster_id == 6 %}
      {% if endpoint_id == 1 and command == 'on' %}top{% elif endpoint_id == 1 and command == 'off' %}bottom
      {% elif endpoint_id == 2 and command == 'on' %}left{% elif endpoint_id == 3 and command == 'on' %}right
      {% else %}unknown{% endif %}
    {% elif cluster_id == 8 %}
      {% if endpoint_id == 1 and (command == 'move_with_on_off') %}hold_increase_top
      {% elif endpoint_id == 1 and command == 'move' %}hold_decrease_bottom
      {% elif endpoint_id == 2 and (command in ['move','move_with_on_off']) %}hold_left
      {% elif endpoint_id == 3 and (command in ['move','move_with_on_off']) %}hold_right
      {% else %}unknown{% endif %}
    {% else %}
      unknown
    {% endif %}

  is_hold: >
    {{ 'hold' in button_name }}

  is_click: >
    {{ button_name in ['top','bottom','left','right'] }}

action:
  - choose:
      # HOLD ACTIONS
      - conditions:
          - condition: template
            value_template: "{{ is_hold }}"
        sequence:
          - choose:
              - conditions: "{{ button_name == 'hold_increase_top' }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ only_bright }}"
                        sequence: !input hold_increase_top
                      - conditions: []
                        sequence: !input hold_increase_top

              - conditions: "{{ button_name == 'hold_decrease_bottom' }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ only_bright }}"
                        sequence: !input hold_decrease_bottom
                      - conditions: []
                        sequence: !input hold_decrease_bottom

              - conditions: "{{ button_name == 'hold_left' }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ only_left }}"
                        sequence: !input hold_left
                      - conditions: []
                        sequence: !input hold_left

              - conditions: "{{ button_name == 'hold_right' }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ only_right }}"
                        sequence: !input hold_right
                      - conditions: []
                        sequence: !input hold_right

      # CLICK ACTIONS
      - conditions:
          - condition: template
            value_template: "{{ is_click }}"
        sequence:
          - variables:
              this_button: "{{ button_name }}"
              click_count: 1
          - wait_for_trigger:
              - platform: event
                event_type: zha_event
                event_data:
                  device_id: !input remote
            timeout: "{{ wt }}"
            continue_on_timeout: true
          - variables:
              click_count: >
                {% if wait.trigger %}
                  {{ click_count + 1 }}
                {% else %}
                  {{ click_count }}
                {% endif %}

          - wait_for_trigger:
              - platform: event
                event_type: zha_event
                event_data:
                  device_id: !input remote
            timeout: "{{ wt }}"
            continue_on_timeout: true
          - variables:
              click_count: >
                {% if wait.trigger %}
                  {{ click_count + 1 }}
                {% else %}
                  {{ click_count }}
                {% endif %}

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ this_button == 'top' }}"
                sequence:
                  - choose:
                      - conditions: "{{ click_count == 1 }}"
                        sequence: !input single_click_action_top
                      - conditions: "{{ click_count == 2 }}"
                        sequence: !input double_click_action_top
                      - conditions: "{{ click_count == 3 }}"
                        sequence: !input triple_click_action_top

              - conditions:
                  - condition: template
                    value_template: "{{ this_button == 'bottom' }}"
                sequence:
                  - choose:
                      - conditions: "{{ click_count == 1 }}"
                        sequence: !input single_click_action_bottom
                      - conditions: "{{ click_count == 2 }}"
                        sequence: !input double_click_action_bottom
                      - conditions: "{{ click_count == 3 }}"
                        sequence: !input triple_click_action_bottom

              - conditions:
                  - condition: template
                    value_template: "{{ this_button == 'left' }}"
                sequence:
                  - choose:
                      - conditions: "{{ click_count == 1 }}"
                        sequence: !input single_click_action_left
                      - conditions: "{{ click_count == 2 }}"
                        sequence: !input double_click_action_left
                      - conditions: "{{ click_count == 3 }}"
                        sequence: !input triple_click_action_left

              - conditions:
                  - condition: template
                    value_template: "{{ this_button == 'right' }}"
                sequence:
                  - choose:
                      - conditions: "{{ click_count == 1 }}"
                        sequence: !input single_click_action_right
                      - conditions: "{{ click_count == 2 }}"
                        sequence: !input double_click_action_right
                      - conditions: "{{ click_count == 3 }}"
                        sequence: !input triple_click_action_right
    default: []
mode: restart
